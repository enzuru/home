(in-package :stumpwm)

(ql:quickload :clx-truetype)

;; Modules

(load-module "cpu")
(load-module "mem")
(load-module "end-session")
(load-module "ttf-fonts")

;; Modes

(which-key-mode)

;; Fonts

(setf xft:*font-dirs* '("/run/current-system/profile/share/fonts/"))
(setf clx-truetype:cache-font-file (concat (getenv "HOME") "/.fonts/font-cache.sexp"))
(clx-truetype:cache-fonts)
;; (set-font (make-instance 'xft:font :family "Iosevka" :subfamily "Regular" :size 15))

;; Variables

(setf *window-border-style* :none
      *hidden-window-color* "^**"
      *mouse-focus-policy* :click
      *float-window-modifier* :SUPER)

;; Modeline

(defparameter cpu::*cpu-modeline-fmt* "%c"
  "just usage percentage")

(setf *mode-line-background-color* "#113450"
      *mode-line-foreground-color* "#FFFFFF"
      *mode-line-position* :bottom
      *mode-line-border-width* 0
      *mode-line-timeout* 2
      *mode-line-highlight-template* "«~A»"
      *time-modeline-string* "%a %b %e %k:%M"
      *window-format* "%m%n%s%c")

(setf *screen-mode-line-format* (list "[^B%n^b] %W^>%c %d"))

(mode-line)

;; Commands

(defcommand hsplit-and-term () ()
  (hsplit)
  (move-focus :right)
  (run-shell-command "urxvtc -fn xft:Iosevka:style=Regular:size=15"))

(defcommand vsplit-and-term () ()
  (vsplit)
  (move-focus :down)
  (run-shell-command "urxvtc -fn xft:Iosevka:style=Regular:size=15"))

(defcommand kill-and-remove-split () ()
  (let ((window (current-window)))
    (remove-split)
    (delete-window window)))

(defcommand gnew-and-term () ()
  (run-commands "gnew")
  (run-shell-command "urxvtc -fn xft:Iosevka:style=Regular:size=15"))

(defcommand gkill-windows-and-group () ()
  (let* ((group (current-group))
         (group-windows (group-windows group)))
    (gkill)
    (kill-windows group-windows)))

;; tmux emulation

;;; Groups

(define-key *root-map* (kbd "c") "gnew-and-term")
(define-key *root-map* (kbd "n") "gnext")
(define-key *root-map* (kbd "p") "gprev")
(define-key *root-map* (kbd "&") "gkill-windows-and-group")

;;; Splitting

(define-key *root-map* (kbd "o") "fother")
(define-key *root-map* (kbd "%") "hsplit-and-term")
(define-key *root-map* (kbd "\"") "vsplit-and-term")
(define-key *root-map* (kbd "x") "kill-and-remove-split")

;;; Windows

(define-key *root-map* (kbd "b") "select-window")

(if *initializing*
    (progn
      (let ((group (add-group (current-screen) "icecat")))
        (run-shell-command "urxvtc -fn xft:Iosevka:style=Regular:size=15 -e icecat")
        (move-window-to-group (select-window-by-name "icecat")
                              group))
      (let ((group (add-group (current-screen) "glances")))
        (run-shell-command "urxvtc -fn xft:Iosevka:style=Regular:size=15 -e glances" t)
        (move-window-to-group (select-window-by-name "glances")
                              group))
      (let ((group (add-group (current-screen) "emacs")))
        (run-shell-command "urxvtc -fn xft:Iosevka:style=Regular:size=15 -e emacs")
        (move-window-to-group (select-window-by-name "emacs")
                              group))))
